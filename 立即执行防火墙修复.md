# 🚨 立即执行防火墙修复

## 📊 当前状态

✅ 防火墙已启用（Domain, Private, Public）  
❌ 未找到允许代理连接的出站规则  
❌ 代理连接测试失败

## ✅ 立即解决方案

### 步骤 1: 创建防火墙规则（需要管理员权限）

**以管理员身份运行 PowerShell，然后执行：**

```powershell
# 方法 A: 使用 npm 脚本
npm run create-firewall-rule

# 方法 B: 直接运行脚本
.\scripts\create-firewall-rule.ps1

# 方法 C: 直接执行 PowerShell 命令
New-NetFirewallRule -DisplayName "Allow Node.js Proxy Access" `
    -Direction Outbound `
    -Protocol TCP `
    -RemoteAddress "35.220.189.112" `
    -RemotePort 3128 `
    -Action Allow `
    -Profile Any `
    -Description "Allow Node.js to access proxy server"
```

### 步骤 2: 验证防火墙规则

```powershell
# 检查规则是否创建成功
Get-NetFirewallRule -DisplayName "Allow Node.js Proxy Access"
```

### 步骤 3: 设置环境变量并测试

```powershell
# 设置环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 测试代理连接
npm run test-proxy
```

### 步骤 4: 如果测试成功，启动应用

```powershell
# 使用启动脚本（推荐）
.\start-with-proxy.ps1 dev

# 或直接启动
npm run dev
```

## 🛠️ 手动创建防火墙规则（图形界面）

如果 PowerShell 命令失败，可以手动创建：

1. **打开 Windows Defender 防火墙**
   - 按 `Win + R`
   - 输入: `firewall.cpl`
   - 回车

2. **打开高级设置**
   - 点击左侧的 "高级设置"

3. **创建出站规则**
   - 点击左侧的 "出站规则"
   - 点击右侧的 "新建规则..."

4. **规则类型**: 选择 "端口"

5. **协议和端口**:
   - 选择 "TCP"
   - 选择 "特定远程端口"
   - 输入: `3128`

6. **操作**: 选择 "允许连接"

7. **配置文件**: 全部勾选（域、专用、公用）

8. **名称**: `Allow Node.js Proxy Access`

9. **描述**: `允许 Node.js 应用程序通过代理服务器访问外部网络`

10. **完成**: 点击 "完成"

## 🔍 完整操作流程

```powershell
# 1. 以管理员身份打开 PowerShell
# 右键点击 PowerShell -> 以管理员身份运行

# 2. 切换到项目目录
cd G:\aIpiccenter

# 3. 创建防火墙规则
npm run create-firewall-rule

# 4. 设置环境变量（在新终端或当前终端）
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 5. 测试代理连接
npm run test-proxy

# 6. 如果测试成功，启动应用
.\start-with-proxy.ps1 dev
```

## ⚠️ 重要提示

1. **管理员权限**: 创建防火墙规则需要管理员权限
2. **重启应用**: 创建规则后，需要重启应用才能生效
3. **测试**: 创建规则后，务必测试代理连接

## 🆘 如果仍然失败

1. **检查规则是否创建成功**
   ```powershell
   Get-NetFirewallRule -DisplayName "Allow Node.js Proxy Access"
   ```

2. **临时禁用防火墙测试**（仅用于诊断）
   ```powershell
   # 以管理员身份运行
   Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
   # 测试代理连接
   npm run test-proxy
   # 测试完成后重新启用
   Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
   ```

3. **检查其他安全软件**
   - 企业防病毒软件
   - 第三方防火墙
   - 网络监控软件

4. **联系网络管理员**
   - 如果是企业网络，可能需要网络管理员协助


