# æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿå®ç°æ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®åº“Schemaæ‰©å±• âœ…
- âœ… Fileè¡¨ï¼ˆæ–‡ä»¶ä¸»è¡¨ï¼‰
- âœ… FileMetadataè¡¨ï¼ˆå…ƒæ•°æ®è¡¨ï¼‰
- âœ… FileChunkè¡¨ï¼ˆåˆ†ç‰‡ä¸Šä¼ è¡¨ï¼‰
- âœ… SignedUrlè¡¨ï¼ˆç­¾åURLè¡¨ï¼‰

**æ³¨æ„**: æ•°æ®åº“è¿ç§»éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œå› ä¸ºæ¶‰åŠæ•°æ®ä¸¢å¤±è­¦å‘Šã€‚è¯·è¿è¡Œï¼š
```bash
npx prisma db push --accept-data-loss
```

### 2. æ ¸å¿ƒåº“æ–‡ä»¶ âœ…

#### `lib/file-utils.ts`
- âœ… æ–‡ä»¶ç±»å‹æ£€æµ‹
- âœ… MIMEç±»å‹è¯†åˆ«
- âœ… MD5è®¡ç®—
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶æ£€æŸ¥
- âœ… åˆ†ç‰‡å¤§å°æ¨è

#### `lib/storage.ts`
- âœ… å­˜å‚¨æŠ½è±¡å±‚
- âœ… æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- âœ… AWS S3æ”¯æŒï¼ˆéœ€è¦å®‰è£…SDKï¼‰
- âœ… Cloudflare R2æ”¯æŒï¼ˆå…¼å®¹S3 APIï¼‰
- âœ… MinIOæ”¯æŒï¼ˆå…¼å®¹S3 APIï¼‰
- âœ… ç­¾åURLç”Ÿæˆ

#### `lib/file-processor.ts`
- âœ… å›¾åƒå¤„ç†ï¼ˆsharpï¼‰
- âœ… è§†é¢‘å¤„ç†ï¼ˆffmpegï¼‰
- âœ… éŸ³é¢‘å¤„ç†ï¼ˆffmpegï¼‰
- âœ… PDFæ–‡æœ¬æå–ï¼ˆpdf-parseï¼‰

#### `lib/metadata-extractor.ts`
- âœ… å›¾åƒå…ƒæ•°æ®æå–
- âœ… è§†é¢‘å…ƒæ•°æ®æå–
- âœ… éŸ³é¢‘å…ƒæ•°æ®æå–
- âœ… PDFå…ƒæ•°æ®æå–
- âœ… ä»£ç å…ƒæ•°æ®æå–

#### `lib/content-moderation.ts`
- âœ… å†…å®¹å®¡æ ¸æŠ½è±¡å±‚
- âœ… é˜¿é‡Œäº‘å†…å®¹å®¡æ ¸ï¼ˆæ¡†æ¶ï¼‰
- âœ… è…¾è®¯äº‘å†…å®¹å®¡æ ¸ï¼ˆæ¡†æ¶ï¼‰
- âœ… æ–‡æœ¬å†…å®¹å®¡æ ¸ï¼ˆåŸºç¡€å®ç°ï¼‰

#### `lib/preview-generator.ts`
- âœ… å›¾åƒç¼©ç•¥å›¾ç”Ÿæˆ
- âœ… è§†é¢‘å°é¢ç”Ÿæˆ
- âœ… éŸ³é¢‘æ³¢å½¢ï¼ˆæ¡†æ¶ï¼‰
- âœ… æ–‡æ¡£é¢„è§ˆï¼ˆæ¡†æ¶ï¼‰

### 3. APIç«¯ç‚¹ âœ…

#### `/api/upload/v2` - å®Œæ•´åŠŸèƒ½ä¸Šä¼ 
- âœ… æ”¯æŒæ‰€æœ‰æ–‡ä»¶ç±»å‹
- âœ… è‡ªåŠ¨æ–‡ä»¶å¤„ç†
- âœ… å…ƒæ•°æ®æå–
- âœ… å†…å®¹å®¡æ ¸
- âœ… é¢„è§ˆç”Ÿæˆ
- âœ… AIæ¨¡å‹æ¨è

#### `/api/upload/chunk` - åˆ†ç‰‡ä¸Šä¼ 
- âœ… åˆå§‹åŒ–ä¸Šä¼ 
- âœ… åˆ†ç‰‡ä¸Šä¼ 
- âœ… å®Œæˆä¸Šä¼ 
- âœ… æ–­ç‚¹ç»­ä¼ 
- âœ… MD5æ ¡éªŒ

#### `/api/files` - æ–‡ä»¶åˆ—è¡¨
- âœ… è·å–ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨
- âœ… åˆ†é¡µæ”¯æŒ
- âœ… æ–‡ä»¶ç±»å‹è¿‡æ»¤
- âœ… çŠ¶æ€è¿‡æ»¤

#### `/api/files/[fileId]` - æ–‡ä»¶æ“ä½œ
- âœ… è·å–æ–‡ä»¶è¯¦æƒ…
- âœ… åˆ é™¤æ–‡ä»¶
- âœ… æ›´æ–°æ–‡ä»¶ä¿¡æ¯

#### `/api/files/[fileId]/signed-url` - ç­¾åURL
- âœ… ç”Ÿæˆä¸´æ—¶è®¿é—®é“¾æ¥
- âœ… è¿‡æœŸæ—¶é—´æ§åˆ¶
- âœ… è®¿é—®æ¬¡æ•°é™åˆ¶

### 4. å‰ç«¯ç»„ä»¶ âœ…

#### `components/upload/FileUploader.tsx`
- âœ… æ‹–æ‹½ä¸Šä¼ 
- âœ… å¤šæ–‡ä»¶ä¸Šä¼ 
- âœ… è¿›åº¦æ˜¾ç¤º
- âœ… æ–‡ä»¶é¢„è§ˆ
- âœ… è‡ªåŠ¨åˆ†ç‰‡ä¸Šä¼ ï¼ˆå¤§æ–‡ä»¶ï¼‰
- âœ… é”™è¯¯å¤„ç†

### 5. ç±»å‹å®šä¹‰ âœ…
- âœ… FileUploadResult
- âœ… FileMetadata
- âœ… FileInfo
- âœ… ChunkUploadProgress
- âœ… SignedUrlResponse

### 6. æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† âœ…
- âœ… æ¸…ç†è„šæœ¬ `scripts/cleanup-expired-files.ts`
- âœ… è¿‡æœŸæ–‡ä»¶æ¸…ç†
- âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†
- âœ… ç­¾åURLæ¸…ç†
- âœ… æœªå®Œæˆä¸Šä¼ æ¸…ç†

### 7. æ–‡æ¡£ âœ…
- âœ… `UPLOAD_SYSTEM.md` - å®Œæ•´ä½¿ç”¨æ–‡æ¡£
- âœ… `env.template` - ç¯å¢ƒå˜é‡é…ç½®æ›´æ–°

## ğŸ“‹ å¾…å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®åº“è¿ç§»
éœ€è¦æ‰‹åŠ¨æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼š
```bash
npx prisma db push --accept-data-loss
```

### 2. å¯é€‰ä¾èµ–å®‰è£…
æ ¹æ®éœ€æ±‚å®‰è£…ï¼š
```bash
# å›¾åƒå¤„ç†
npm install sharp

# è§†é¢‘/éŸ³é¢‘å¤„ç†
npm install fluent-ffmpeg
# è¿˜éœ€è¦ç³»ç»Ÿå®‰è£… FFmpeg

# PDFå¤„ç†
npm install pdf-parse

# AWS S3æ”¯æŒ
npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner
```

### 3. å†…å®¹å®¡æ ¸å®Œæ•´å®ç°
- [ ] é˜¿é‡Œäº‘å†…å®¹å®‰å…¨å®Œæ•´é›†æˆ
- [ ] è…¾è®¯äº‘å†…å®¹å®‰å…¨å®Œæ•´é›†æˆ
- [ ] ç™¾åº¦å†…å®¹å®¡æ ¸é›†æˆ

### 4. é¢„è§ˆåŠŸèƒ½å®Œå–„
- [ ] éŸ³é¢‘æ³¢å½¢å›¾ç”Ÿæˆ
- [ ] PDFé¢„è§ˆå›¾ç”Ÿæˆ

### 5. åå°ç®¡ç†ç•Œé¢
- [ ] æ–‡ä»¶ç®¡ç†é¡µé¢
- [ ] å®¡æ ¸ç®¡ç†é¡µé¢
- [ ] ç»Ÿè®¡åˆ†æé¡µé¢

### 6. é˜¿é‡Œäº‘OSSé›†æˆ
- [ ] å®ç°OSSå­˜å‚¨æä¾›è€…

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
npm install
```

### 2. æ•°æ®åº“è¿ç§»
```bash
npx prisma db push --accept-data-loss
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶ `env.template` ä¸º `.env.local` å¹¶é…ç½®ï¼š
- `STORAGE_PROVIDER` - å­˜å‚¨æä¾›å•†
- `MODERATION_PROVIDER` - å†…å®¹å®¡æ ¸æä¾›å•†ï¼ˆå¯é€‰ï¼‰

### 4. å®‰è£…å¯é€‰ä¾èµ–ï¼ˆæ ¹æ®éœ€è¦ï¼‰
```bash
npm install sharp fluent-ffmpeg pdf-parse
```

### 5. ä½¿ç”¨ä¸Šä¼ ç»„ä»¶
```tsx
import FileUploader from '@/components/upload/FileUploader'

<FileUploader
  onUploadComplete={(file) => console.log('ä¸Šä¼ æˆåŠŸ:', file)}
  maxFiles={10}
/>
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç®€å•ä¸Šä¼ 
```typescript
const formData = new FormData()
formData.append('file', file)

const response = await fetch('/api/upload/v2', {
  method: 'POST',
  body: formData,
})

const result = await response.json()
```

### åˆ†ç‰‡ä¸Šä¼ 
```typescript
// 1. åˆå§‹åŒ–
const initResponse = await fetch('/api/upload/chunk', {
  method: 'POST',
  body: JSON.stringify({
    action: 'init',
    filename: 'large-video.mp4',
    size: file.size,
    mimeType: file.type,
    md5: fileMd5,
  }),
})

// 2. ä¸Šä¼ åˆ†ç‰‡
for (let i = 0; i < totalChunks; i++) {
  await fetch('/api/upload/chunk', {
    method: 'POST',
    body: JSON.stringify({
      action: 'upload',
      fileId: fileId,
      chunkIndex: i,
      chunk: chunkBase64,
      chunkMd5: chunkMd5,
    }),
  })
}

// 3. å®Œæˆ
await fetch('/api/upload/chunk', {
  method: 'POST',
  body: JSON.stringify({
    action: 'complete',
    fileId: fileId,
  }),
})
```

### ç”Ÿæˆç­¾åURL
```typescript
const response = await fetch(`/api/files/${fileId}/signed-url`, {
  method: 'POST',
  body: JSON.stringify({
    expiresIn: 3600, // 1å°æ—¶
    maxAccess: 10,   // æœ€å¤šè®¿é—®10æ¬¡
  }),
})
```

## ğŸ”§ é…ç½®è¯´æ˜

### å­˜å‚¨é…ç½®
- `local` - æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆé»˜è®¤ï¼Œå¼€å‘ç¯å¢ƒï¼‰
- `s3` - AWS S3ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
- `r2` - Cloudflare R2ï¼ˆæ€§ä»·æ¯”é«˜ï¼‰
- `oss` - é˜¿é‡Œäº‘OSSï¼ˆå›½å†…å¿«é€Ÿï¼‰
- `minio` - MinIOï¼ˆè‡ªå»ºå¯¹è±¡å­˜å‚¨ï¼‰

### å†…å®¹å®¡æ ¸é…ç½®
- `mock` - æ¨¡æ‹Ÿå®¡æ ¸ï¼ˆå¼€å‘ç¯å¢ƒï¼Œé»˜è®¤ï¼‰
- `aliyun` - é˜¿é‡Œäº‘å†…å®¹å®‰å…¨ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
- `tencent` - è…¾è®¯äº‘å†…å®¹å®‰å…¨
- `baidu` - ç™¾åº¦å†…å®¹å®¡æ ¸

## ğŸ“Š æ–‡ä»¶å¤„ç†æµç¨‹

1. **ä¸Šä¼ ** â†’ æ–‡ä»¶éªŒè¯ â†’ MIMEç±»å‹æ ¡éªŒ
2. **å®¡æ ¸** â†’ å†…å®¹å®¡æ ¸ï¼ˆå¼‚æ­¥ï¼‰
3. **å¤„ç†** â†’ è½¬ç /å‹ç¼© â†’ å…ƒæ•°æ®æå– â†’ é¢„è§ˆç”Ÿæˆ
4. **å­˜å‚¨** â†’ ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ â†’ ä¿å­˜æ•°æ®åº“è®°å½•
5. **å®Œæˆ** â†’ è¿”å›æ–‡ä»¶ä¿¡æ¯ â†’ AIæ¨¡å‹æ¨è

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- âœ… MIMEç±»å‹éªŒè¯ï¼ˆé˜²æ­¢æ–‡ä»¶ä¼ªè£…ï¼‰
- âœ… å†…å®¹å®¡æ ¸ï¼ˆå›¾åƒ/æ–‡æœ¬/è§†é¢‘ï¼‰
- âœ… è®¿é—®æƒé™æ§åˆ¶ï¼ˆç§æœ‰/å…¬å¼€/å…±äº«ï¼‰
- âœ… ç­¾åURLï¼ˆä¸´æ—¶è®¿é—®ï¼Œè¿‡æœŸæ§åˆ¶ï¼‰
- âœ… MD5æ ¡éªŒï¼ˆæ–‡ä»¶å®Œæ•´æ€§ï¼‰

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®Œæ•´æ–‡æ¡£](./UPLOAD_SYSTEM.md)
- [ç¯å¢ƒé…ç½®](./env.template)
- [æ•°æ®åº“è®¾ç½®](./DATABASE_SETUP.md)

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ `npx prisma db push --accept-data-loss`
2. **å¯é€‰ä¾èµ–**: æ ¹æ®éœ€æ±‚å®‰è£… sharpã€ffmpegã€pdf-parse ç­‰
3. **FFmpeg**: è§†é¢‘/éŸ³é¢‘å¤„ç†éœ€è¦ç³»ç»Ÿå®‰è£… FFmpeg
4. **å†…å®¹å®¡æ ¸**: ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®é…ç½®çœŸå®çš„å†…å®¹å®¡æ ¸æœåŠ¡
5. **å¯¹è±¡å­˜å‚¨**: å¤§æ–‡ä»¶ä¸Šä¼ å»ºè®®ä½¿ç”¨å¯¹è±¡å­˜å‚¨è€Œéæœ¬åœ°å­˜å‚¨
6. **å®šæ—¶ä»»åŠ¡**: æ–‡ä»¶æ¸…ç†è„šæœ¬éœ€è¦æ·»åŠ åˆ° cron job æˆ–å®šæ—¶ä»»åŠ¡

## ğŸ¯ ä¸‹ä¸€æ­¥

1. æ‰§è¡Œæ•°æ®åº“è¿ç§»
2. å®‰è£…å¯é€‰ä¾èµ–ï¼ˆæ ¹æ®éœ€è¦ï¼‰
3. é…ç½®ç¯å¢ƒå˜é‡
4. æµ‹è¯•ä¸Šä¼ åŠŸèƒ½
5. é…ç½®å†…å®¹å®¡æ ¸ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
6. é…ç½®å¯¹è±¡å­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
7. è®¾ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡

