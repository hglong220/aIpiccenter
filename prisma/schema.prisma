generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  username            String?              @unique
  phone               String               @unique
  email               String?              @unique
  password            String
  credits             Int                  @default(0)
  plan                String               @default("free")
  planExpiresAt       DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  generations         Generation[]
  orders              Order[]
  sessions            Session[]
  verificationCodes   VerificationCode[]
  passwordResetTokens PasswordResetToken[]
  chatSessions        ChatSession[]
  files               File[]
  aiTasks             AITask[]
  projects            Project[]
  projectShares       ProjectShare[]  // ä¸æˆ‘å…±äº«çš„é¡¹ç›®
  moderationLogs      ModerationLog[]
  feedbacks           Feedback[]

  @@index([username])
}

model VerificationCode {
  id        String   @id @default(cuid())
  phone     String
  code      String
  type      String
  used      Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([phone, code])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
}

model Order {
  id            String    @id @default(cuid())
  userId        String
  planId        String
  planName      String
  amount        Int
  credits       Int
  paymentMethod String    @default("wechat")
  paymentStatus String    @default("pending")
  wechatOrderId String?
  transactionId String?
  paidAt        DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([paymentStatus])
  @@index([wechatOrderId])
}

model Generation {
  id             String   @id @default(cuid())
  userId         String
  type           String
  prompt         String
  negativePrompt String?
  width          Int?
  height         Int?
  model          String?
  imageUrl       String?
  videoUrl       String?
  creditsUsed    Int
  status         String   @default("pending")
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id])
  projectGenerations ProjectGeneration[]

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatSession {
  id        String         @id @default(cuid())
  userId    String
  title     String?
  isStarred Boolean        @default(false)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  
  // å…³è”é¡¹ç›®ï¼ˆç”¨äºAIä¸Šä¸‹æ–‡ï¼‰
  projectId String?
  project   Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([projectId])
}

model ChatMessage {
  id        String       @id @default(cuid())
  chatId    String
  role      String
  content   String
  imagePath String?
  createdAt DateTime     @default(now())
  chat      ChatSession  @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId, createdAt])
}

// ============================================
// æ–‡ä»¶ä¸Šä¼ ç³»ç»Ÿç›¸å…³æ¨¡å‹
// ============================================

// æ–‡ä»¶ä¸»è¡¨
model File {
  id                String        @id @default(cuid())
  userId            String
  originalFilename  String
  filename          String        @unique
  mimeType          String
  fileType          String        // image, video, audio, document, code, archive, 3d, other
  size              Int           // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  md5               String        @unique
  storageProvider   String        @default("local") // local, s3, oss, r2, minio
  storagePath       String        // å­˜å‚¨è·¯å¾„
  storageUrl        String?       // å­˜å‚¨URLï¼ˆå¦‚æœæ”¯æŒï¼‰
  previewUrl        String?       // é¢„è§ˆURL
  thumbnailUrl      String?       // ç¼©ç•¥å›¾URL
  accessLevel       String        @default("private") // private, public, shared
  status            String        @default("uploading") // uploading, processing, ready, failed, deleted
  moderationStatus  String        @default("pending") // pending, approved, rejected, flagged
  moderationReason  String?       // å®¡æ ¸æ‹’ç»åŸå› 
  virusScanStatus   String        @default("pending") // pending, clean, infected
  virusScanResult   String?       // ç—…æ¯’æ‰«æç»“æœ
  expiresAt         DateTime?     // æ–‡ä»¶è¿‡æœŸæ—¶é—´ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰
  retentionDays     Int?         // ä¿ç•™å¤©æ•°ï¼ˆnullè¡¨ç¤ºæ°¸ä¹…ï¼‰
  creditsUsed       Int           @default(0) // ä¸Šä¼ /å¤„ç†æ¶ˆè€—çš„ç§¯åˆ†
  metadata          FileMetadata?
  chunks            FileChunk[]
  signedUrls        SignedUrl[]
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([fileType])
  @@index([status])
  @@index([moderationStatus])
  @@index([md5])
  @@index([createdAt])
  @@index([expiresAt])
}

// æ–‡ä»¶å…ƒæ•°æ®è¡¨
model FileMetadata {
  id                String   @id @default(cuid())
  fileId            String   @unique
  file              File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  // é€šç”¨å…ƒæ•°æ®
  width             Int?
  height            Int?
  aspectRatio       String?  // 16:9, 4:3, 1:1, etc.
  colorMode         String?  // RGB, RGBA, Grayscale, etc.
  duration          Float?   // è§†é¢‘/éŸ³é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
  bitrate           Int?     // ç ç‡ï¼ˆbpsï¼‰
  codec             String?  // ç¼–ç æ ¼å¼
  fps               Float?   // å¸§ç‡
  sampleRate        Int?     // éŸ³é¢‘é‡‡æ ·ç‡
  channels          Int?     // éŸ³é¢‘å£°é“æ•°
  
  // æ–‡æ¡£å…ƒæ•°æ®
  pageCount         Int?
  wordCount         Int?
  language          String?  // æ£€æµ‹åˆ°çš„è¯­è¨€
  extractedText     String?  // æå–çš„æ–‡æœ¬å†…å®¹
  
  // ä»£ç å…ƒæ•°æ®
  programmingLanguage String?
  linesOfCode       Int?
  fileStructure     String?  // JSONæ ¼å¼çš„æ–‡ä»¶ç»“æ„
  dependencies      String?  // JSONæ ¼å¼çš„ä¾èµ–åˆ—è¡¨
  
  // å…¶ä»–å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼å­˜å‚¨ï¼‰
  extraMetadata     String?  // JSONæ ¼å¼
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// åˆ†ç‰‡ä¸Šä¼ è¡¨ï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰
model FileChunk {
  id            String   @id @default(cuid())
  fileId        String
  file          File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  chunkIndex    Int      // åˆ†ç‰‡ç´¢å¼•ï¼ˆä»0å¼€å§‹ï¼‰
  chunkSize     Int      // åˆ†ç‰‡å¤§å°
  chunkMd5      String   // åˆ†ç‰‡MD5
  uploaded      Boolean  @default(false)
  uploadedAt    DateTime?
  createdAt     DateTime @default(now())

  @@unique([fileId, chunkIndex])
  @@index([fileId])
}

// ç­¾åURLè¡¨ï¼ˆä¸´æ—¶è®¿é—®é“¾æ¥ï¼‰
model SignedUrl {
  id          String   @id @default(cuid())
  fileId      String
  file        File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  token       String   @unique
  url         String
  expiresAt   DateTime
  accessCount Int      @default(0)
  maxAccess   Int?     // nullè¡¨ç¤ºæ— é™åˆ¶
  createdAt   DateTime @default(now())

  @@index([fileId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================
// AIä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿç›¸å…³æ¨¡å‹
// ============================================

// AIä»»åŠ¡è¡¨
model AITask {
  id             String   @id @default(cuid())
  userId         String
  taskType       String   // text, image, video, audio, document, code, composite
  priority       String   @default("normal") // low, normal, high, urgent
  status         String   @default("pending") // pending, running, success, failed, retry
  model          String?  // ä½¿ç”¨çš„æ¨¡å‹ç±»å‹
  fallbackModels String?  // JSONæ ¼å¼çš„é™çº§æ¨¡å‹åˆ—è¡¨
  requestData    String   // JSONæ ¼å¼çš„è¯·æ±‚æ•°æ®
  resultData     String?  // JSONæ ¼å¼çš„ç»“æœæ•°æ®
  error          String?  // é”™è¯¯ä¿¡æ¯
  retryCount     Int      @default(0)
  maxRetries     Int      @default(3)
  progress       Int      @default(0) // 0-100
  estimatedTime  Int?     // é¢„ä¼°æ—¶é—´ï¼ˆç§’ï¼‰
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([taskType])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ============================================
// é¡¹ç›®ç®¡ç†ç³»ç»Ÿç›¸å…³æ¨¡å‹
// ============================================

// é¡¹ç›®è¡¨

// ============================================
// å†…å®¹å®¡æ ¸ç³»ç»Ÿç›¸å…³æ¨¡å‹
// ============================================

// å®¡æ ¸æ—¥å¿—è¡¨
model ModerationLog {
  id          String   @id @default(cuid())
  userId      String
  contentType String   // text, image, video, audio
  content     String   // URLæˆ–æ–‡æœ¬å†…å®¹ï¼ˆæ–‡æœ¬åªä¿å­˜å‰500å­—ç¬¦ï¼‰
  riskLevel   String   // pass, review, block
  categories  String?  // JSONæ ¼å¼çš„è¿è§„ç±»åˆ«
  score       Int      @default(0) // é£é™©è¯„åˆ† 0-100
  passed      Boolean  @default(false)
  reason      String?  // å®¡æ ¸åŸå› 
  action      String   // pass, block, review
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contentType])
  @@index([riskLevel])
  @@index([action])
  @@index([createdAt])

  feedbacks Feedback[]
}

// ç”¨æˆ·åé¦ˆè¡¨
model Feedback {
  id              String         @id @default(cuid())
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  moderationLogId String?
  moderationLog   ModerationLog? @relation(fields: [moderationLogId], references: [id], onDelete: SetNull)
  type            String         // åé¦ˆç±»å‹ï¼Œå¦‚ï¼šä¸€èˆ¬æ„è§ã€é—®é¢˜/æ¼æ´ã€å„¿ç«¥å®‰å…¨ç­‰
  content         String         // åé¦ˆå†…å®¹
  page            String?        // æäº¤åé¦ˆæ‰€åœ¨çš„é¡µé¢æˆ–è§†å›¾
  metadata        String?        // å…¶ä»–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆJSONï¼‰
  createdAt       DateTime       @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// é¡¹ç›®è¡¨ - AIä¸Šä¸‹æ–‡æŒä¹…åŒ–
model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  
  // è‡ªå®šä¹‰æŒ‡ä»¤ - AIè§’è‰²è®¾å®š
  instructions String?  // å­˜å‚¨ä¸ºçº¯æ–‡æœ¬
  
  // é¡¹ç›®å›¾æ ‡/Emoji
  icon        String?  @default("ğŸ“¦")
  
  // æ˜¯å¦ä¸ºç¤ºä¾‹é¡¹ç›®
  isExample   Boolean  @default(false)
  
  // å°é¢å›¾ï¼ˆå¯é€‰ï¼‰
  coverImage  String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // å…³è”
  files       ProjectFile[]
  generations ProjectGeneration[]
  shares      ProjectShare[]
  chatSessions ChatSession[] // å…³è”åˆ°æ­¤é¡¹ç›®çš„å¯¹è¯
  
  @@index([userId])
  @@index([isExample])
}

// é¡¹ç›®æ–‡ä»¶è¡¨ - çŸ¥è¯†åº“
model ProjectFile {
  id         String   @id @default(cuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  fileName   String
  fileUrl    String
  fileSize   Int
  fileType   String
  
  // æ–‡ä»¶å†…å®¹ï¼ˆæå–çš„æ–‡æœ¬ï¼Œç”¨äºAIæ£€ç´¢ï¼‰
  content    String?  // å­˜å‚¨æå–çš„æ–‡æœ¬å†…å®¹
  
  uploadedAt DateTime @default(now())
  
  @@index([projectId])
}

// é¡¹ç›®ç”Ÿæˆè®°å½•å…³è”è¡¨
model ProjectGeneration {
  id           String     @id @default(cuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  generationId String
  generation   Generation @relation(fields: [generationId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  
  @@unique([projectId, generationId])
  @@index([projectId])
  @@index([generationId])
}

// é¡¹ç›®å…±äº«è¡¨
model ProjectShare {
  id         String   @id @default(cuid())
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  sharedWithId String   // è¢«åˆ†äº«çš„ç”¨æˆ·ID
  sharedWith   User     @relation(fields: [sharedWithId], references: [id], onDelete: Cascade)
  
  permission String   @default("read") // "read" | "write"
  
  sharedAt   DateTime @default(now())
  
  @@unique([projectId, sharedWithId])
  @@index([sharedWithId])
}

// AI API ç®¡ç†ç³»ç»Ÿ
model AIProvider {
  id          String    @id @default(cuid())
  name        String    @unique // gemini, claude, gpt, midjourneyç­‰
  type        String    // chat, image, video
  displayName String    // æ˜¾ç¤ºåç§°
  description String?   // æè¿°
  enabled     Boolean   @default(true)
  config      String?   // JSONé…ç½®
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  apiKeys     APIKey[]

  @@index([type])
  @@index([enabled])
}

model APIKey {
  id                   String     @id @default(cuid())
  providerId           String
  provider             AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name                 String     // å¯†é’¥åç§°/æ ‡è¯†
  apiKey               String     // åŠ å¯†çš„APIå¯†é’¥
  endpoint             String?    // APIç«¯ç‚¹
  enabled              Boolean    @default(true)
  priority             Int        @default(50) // ä¼˜å…ˆçº§ 1-100
  weight               Int        @default(1) // æƒé‡ï¼Œç”¨äºè´Ÿè½½å‡è¡¡
  maxRequestsPerMinute Int?       // é€Ÿç‡é™åˆ¶
  currentUsage         Int        @default(0) // å½“å‰åˆ†é’Ÿä½¿ç”¨æ¬¡æ•°
  totalRequests        Int        @default(0) // æ€»è¯·æ±‚æ•°
  successfulRequests   Int        @default(0) // æˆåŠŸè¯·æ±‚æ•°
  failedRequests       Int        @default(0) // å¤±è´¥è¯·æ±‚æ•°
  lastUsedAt           DateTime?  // æœ€åä½¿ç”¨æ—¶é—´
  lastErrorAt          DateTime?  // æœ€åé”™è¯¯æ—¶é—´
  lastResetAt          DateTime   @default(now()) // ä¸Šæ¬¡é‡ç½®æ—¶é—´
  status               String     @default("active") // active, rate_limited, error, disabled
  metadata             String?    // JSONå…ƒæ•°æ®
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([providerId])
  @@index([enabled])
  @@index([status])
  @@index([priority])
}
