# ğŸ” æµå¼å“åº”è§£æé”™è¯¯è°ƒè¯•æŒ‡å—

## é”™è¯¯ä¿¡æ¯

å¦‚æœçœ‹åˆ° `é”™è¯¯: Failed to parse stream response`ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ’æŸ¥ï¼š

## ğŸ“‹ æ’æŸ¥æ­¥éª¤

### 1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—

æŸ¥çœ‹æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡ºï¼ŒæŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹æ˜¯å¦æœ‰è¿™äº›æ—¥å¿—
[Gemini] Failed to parse stream buffer: ...
[Gemini] Buffer content: ...
[Gemini] No data was extracted from stream after X chunks
```

### 2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ï¼š

- **Network æ ‡ç­¾**ï¼š
  - æ‰¾åˆ° `/api/ai/gemini` è¯·æ±‚
  - æŸ¥çœ‹ Response æ ‡ç­¾ï¼Œæ£€æŸ¥å®é™…è¿”å›çš„æ•°æ®æ ¼å¼
  - æŸ¥çœ‹ Headersï¼Œç¡®è®¤ `Content-Type: text/event-stream`

- **Console æ ‡ç­¾**ï¼š
  - æŸ¥çœ‹æ˜¯å¦æœ‰è§£æé”™è¯¯
  - æŸ¥çœ‹æ¥æ”¶åˆ°çš„æ•°æ®æ ¼å¼

### 3. æ£€æŸ¥ Gemini API å“åº”æ ¼å¼

Gemini API æµå¼å“åº”åº”è¯¥æ˜¯ **NDJSON æ ¼å¼**ï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰ï¼š

```json
{"candidates":[{"content":{"parts":[{"text":"Hello"}]}}]}
{"candidates":[{"content":{"parts":[{"text":" World"}]}}]}
{"candidates":[{"content":{"parts":[{"text":"!"}]}}]}
```

### 4. å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜ 1: ä»£ç†æœåŠ¡å™¨ä¿®æ”¹äº†å“åº”æ ¼å¼

**ç—‡çŠ¶**ï¼š
- å“åº”æ ¼å¼ä¸æ˜¯æ ‡å‡†çš„ NDJSON
- å¯èƒ½è¢«ä»£ç†æœåŠ¡å™¨åŒ…è£…æˆ–ä¿®æ”¹

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¸´æ—¶ç¦ç”¨ä»£ç†æµ‹è¯•
# åœ¨ .env.local ä¸­æ³¨é‡Šæ‰ä»£ç†é…ç½®
# GEMINI_PROXY_URL=
```

#### é—®é¢˜ 2: ç½‘ç»œä¸­æ–­å¯¼è‡´æ•°æ®ä¸å®Œæ•´

**ç—‡çŠ¶**ï¼š
- æ—¥å¿—æ˜¾ç¤º "Failed to parse stream buffer"
- Buffer å†…å®¹ä¸å®Œæ•´

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥ç¨³å®šæ€§
- æ£€æŸ¥ä»£ç†æœåŠ¡å™¨çŠ¶æ€
- å°è¯•ç›´æ¥è¿æ¥ï¼ˆä¸ä½¿ç”¨ä»£ç†ï¼‰

#### é—®é¢˜ 3: API å¯†é’¥é—®é¢˜

**ç—‡çŠ¶**ï¼š
- å“åº”ä¸ºç©ºæˆ–é”™è¯¯
- çŠ¶æ€ç ä¸æ˜¯ 200

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $GOOGLE_GEMINI_API_KEY

# ç¡®è®¤ API å¯†é’¥æœ‰æ•ˆ
curl "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=YOUR_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{"contents":[{"parts":[{"text":"test"}]}]}'
```

#### é—®é¢˜ 4: æ¨¡å‹ä¸å¯ç”¨

**ç—‡çŠ¶**ï¼š
- API è¿”å› 404 æˆ–æ¨¡å‹ä¸å­˜åœ¨é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®
# å½“å‰æ”¯æŒçš„æ¨¡å‹ï¼š
# - gemini-2.5-flash (æ¨èï¼Œæœ€å¿«)
# - gemini-2.5-pro
# - gemini-1.5-flash
# - gemini-1.5-pro

# åœ¨ .env.local ä¸­è®¾ç½®
GOOGLE_GEMINI_MODEL=gemini-2.5-flash
```

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### 1. æµ‹è¯•æµå¼ API ç›´æ¥è°ƒç”¨

```bash
# ä½¿ç”¨ curl æµ‹è¯•æµå¼ API
curl -X POST \
  "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:streamGenerateContent?key=YOUR_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "contents": [{
      "parts": [{"text": "Hello"}]
    }]
  }' \
  --no-buffer
```

### 2. æ£€æŸ¥æœåŠ¡å™¨ç«¯æ—¥å¿—

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼ŒæœåŠ¡å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
npm run dev

# æŸ¥æ‰¾ä»¥ä¸‹æ—¥å¿—ï¼š
[Gemini] Stream API URL: ...
[Gemini] Request prompt length: ...
[Gemini] Stream response status: ...
```

### 3. ä½¿ç”¨æµè§ˆå™¨ Network é¢æ¿

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Network æ ‡ç­¾
3. å‘é€ä¸€æ¡æ¶ˆæ¯
4. æ‰¾åˆ° `/api/ai/gemini` è¯·æ±‚
5. ç‚¹å‡»æŸ¥çœ‹ï¼š
   - **Headers**: æ£€æŸ¥è¯·æ±‚å’Œå“åº”å¤´
   - **Preview**: æŸ¥çœ‹è§£æåçš„æ•°æ®
   - **Response**: æŸ¥çœ‹åŸå§‹å“åº”æ•°æ®

## ğŸ”§ ä¸´æ—¶ä¿®å¤æ–¹æ¡ˆ

å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå¯ä»¥ä¸´æ—¶ç¦ç”¨æµå¼ä¼ è¾“ï¼š

### æ–¹æ¡ˆ 1: ç¦ç”¨æµå¼ä¼ è¾“ï¼ˆå›é€€åˆ°éæµå¼ï¼‰

åœ¨å‰ç«¯ä»£ç ä¸­ï¼š

```javascript
fetch('/api/ai/gemini', {
  method: 'POST',
  body: JSON.stringify({
    prompt: 'ä½ å¥½',
    stream: false  // ç¦ç”¨æµå¼ä¼ è¾“
  })
})
```

### æ–¹æ¡ˆ 2: æ£€æŸ¥å¹¶ä¿®å¤ä»£ç†é…ç½®

```bash
# æµ‹è¯•ä»£ç†è¿æ¥
curl -x $GEMINI_PROXY_URL https://www.google.com

# å¦‚æœä»£ç†æœ‰é—®é¢˜ï¼Œå°è¯•æ›´æ¢æˆ–ç¦ç”¨
```

## ğŸ“Š é¢„æœŸè¡Œä¸º

### æ­£å¸¸æƒ…å†µ

1. **æœåŠ¡å™¨æ—¥å¿—**ï¼š
   ```
   [Gemini] Stream response status: 200
   [Gemini] Stream response body received
   ```

2. **æµè§ˆå™¨ Network**ï¼š
   - Status: 200
   - Content-Type: `text/event-stream`
   - æ•°æ®æ ¼å¼ï¼š`data: {"text":"..."}\n\n`

3. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - 0.5-1ç§’å†…å¼€å§‹æ˜¾ç¤ºå†…å®¹
   - å†…å®¹é€æ­¥æ˜¾ç¤ºï¼ˆæµå¼ï¼‰

### å¼‚å¸¸æƒ…å†µ

å¦‚æœçœ‹åˆ°ä»¥ä¸‹æƒ…å†µï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼š

1. **å“åº”æ ¼å¼é”™è¯¯**ï¼š
   - ä¸æ˜¯ `text/event-stream`
   - æ•°æ®æ ¼å¼ä¸æ˜¯ `data: {...}\n\n`

2. **è§£æé”™è¯¯**ï¼š
   - æ—¥å¿—æ˜¾ç¤º "Failed to parse"
   - Buffer å†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„ JSON

3. **ç©ºå“åº”**ï¼š
   - æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ•°æ®
   - Buffer ä¸ºç©º

## ğŸ†˜ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æœåŠ¡å™¨æ—¥å¿—**ï¼ˆåŒ…å« `[Gemini]` çš„æ‰€æœ‰æ—¥å¿—ï¼‰
2. **æµè§ˆå™¨ Network é¢æ¿æˆªå›¾**ï¼ˆæ˜¾ç¤ºè¯·æ±‚å’Œå“åº”ï¼‰
3. **ç¯å¢ƒä¿¡æ¯**ï¼š
   - Node.js ç‰ˆæœ¬
   - æ˜¯å¦ä½¿ç”¨ä»£ç†
   - Gemini API å¯†é’¥æ˜¯å¦æœ‰æ•ˆ
   - ä½¿ç”¨çš„æ¨¡å‹åç§°

## ğŸ“ æœ€æ–°æ”¹è¿›

å·²å®Œæˆçš„æ”¹è¿›ï¼š

- âœ… æ”¹è¿› JSON è§£æé€»è¾‘ï¼Œå¤„ç†ä¸å®Œæ•´çš„ JSON
- âœ… æ·»åŠ æ§åˆ¶å­—ç¬¦æ¸…ç†
- âœ… æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- âœ… è·³è¿‡é JSON è¡Œ
- âœ… æ›´å¥½çš„ buffer å¤„ç†

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

