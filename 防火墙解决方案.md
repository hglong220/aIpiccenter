# 🔥 Windows 防火墙解决方案

## 📊 当前状态

代理连接测试失败，可能是 Windows 防火墙阻止了连接。

## ✅ 解决方案

### 方案 1: 自动创建防火墙规则（推荐）

**需要管理员权限运行 PowerShell：**

```powershell
# 以管理员身份运行 PowerShell，然后执行：
npm run create-firewall-rule
```

或者直接运行脚本：

```powershell
# 以管理员身份运行 PowerShell
.\scripts\create-firewall-rule.ps1
```

### 方案 2: 手动创建防火墙规则

1. **打开 Windows Defender 防火墙**
   - 按 `Win + S` 搜索 "Windows Defender 防火墙"
   - 或打开 "控制面板" -> "系统和安全" -> "Windows Defender 防火墙"

2. **打开高级设置**
   - 点击左侧的 "高级设置"

3. **创建出站规则**
   - 点击左侧的 "出站规则"
   - 点击右侧的 "新建规则..."

4. **配置规则**
   - **规则类型**: 选择 "端口"
   - **协议和端口**: 
     - 选择 "TCP"
     - 选择 "特定远程端口"
     - 输入: `3128`
   - **操作**: 选择 "允许连接"
   - **配置文件**: 全部勾选（域、专用、公用）
   - **名称**: `Allow Node.js Proxy Access`
   - **描述**: `允许 Node.js 应用程序通过代理服务器访问外部网络`

5. **完成**
   - 点击 "完成"

### 方案 3: 临时禁用防火墙（仅用于测试）

⚠️ **警告**: 仅用于测试，测试完成后请重新启用防火墙！

1. **临时禁用防火墙**
   ```powershell
   # 以管理员身份运行
   Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
   ```

2. **测试代理连接**
   ```powershell
   npm run test-proxy
   ```

3. **重新启用防火墙**
   ```powershell
   # 测试完成后，重新启用防火墙
   Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
   ```

## 🔍 检查防火墙状态

运行以下命令检查防火墙状态：

```powershell
npm run check-firewall
```

## 📝 完整操作流程

### 步骤 1: 检查防火墙

```powershell
npm run check-firewall
```

### 步骤 2: 创建防火墙规则（需要管理员权限）

```powershell
# 以管理员身份运行 PowerShell
npm run create-firewall-rule
```

### 步骤 3: 设置环境变量并测试

```powershell
# 设置环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 测试代理连接
npm run test-proxy
```

### 步骤 4: 如果测试成功，启动应用

```powershell
# 使用启动脚本（推荐）
.\start-with-proxy.ps1 dev

# 或直接启动
npm run dev
```

## 🛠️ 手动创建防火墙规则的详细步骤

### 方法 A: 通过图形界面

1. **打开 Windows Defender 防火墙**
   ```
   Win + R -> 输入: firewall.cpl -> 回车
   ```

2. **打开高级设置**
   - 点击 "高级设置"

3. **创建出站规则**
   - 左侧: "出站规则"
   - 右侧: "新建规则..."

4. **规则类型**: 端口

5. **协议和端口**:
   - TCP
   - 特定远程端口: `3128`

6. **操作**: 允许连接

7. **配置文件**: 全部勾选

8. **名称**: `Allow Node.js Proxy Access`

### 方法 B: 通过 PowerShell（需要管理员权限）

```powershell
# 以管理员身份运行 PowerShell
New-NetFirewallRule -DisplayName "Allow Node.js Proxy Access" `
    -Direction Outbound `
    -Protocol TCP `
    -RemoteAddress "35.220.189.112" `
    -RemotePort 3128 `
    -Action Allow `
    -Profile Any `
    -Description "允许 Node.js 应用程序通过代理服务器访问外部网络"
```

## ⚠️ 重要提示

1. **管理员权限**: 创建防火墙规则需要管理员权限
2. **安全考虑**: 只允许必要的端口和地址
3. **测试**: 创建规则后，务必测试代理连接
4. **日志**: 如果仍然失败，检查 Windows 事件查看器中的防火墙日志

## 🆘 如果仍然失败

1. **检查防火墙日志**
   - 打开 "事件查看器"
   - Windows 日志 -> 安全
   - 查找被阻止的连接

2. **检查其他安全软件**
   - 企业防病毒软件
   - 第三方防火墙
   - 网络监控软件

3. **联系网络管理员**
   - 如果是企业网络，可能需要网络管理员协助
   - 可能需要配置企业防火墙规则

## 📚 相关文档

- [立即修复代理问题.md](./立即修复代理问题.md) - 快速修复指南
- [代理问题解决方案.md](./代理问题解决方案.md) - 完整解决方案


