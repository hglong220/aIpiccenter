# 🚨 立即修复 Google Gemini API 代理问题

## 当前问题
Google Gemini API 调用失败，提示需要设置代理环境变量。

## ✅ 解决方案（按优先级）

### ⭐ 方案 1: 使用启动脚本（推荐，最简单）

**停止当前应用**（如果正在运行，按 `Ctrl+C`）

**然后运行：**

```powershell
# Windows PowerShell
.\start-with-proxy.ps1 dev
```

**或者：**
```bash
npm run dev:proxy
```

这会自动设置所有必需的代理环境变量并启动应用。

### 方案 2: 手动设置环境变量

**在当前 PowerShell 窗口中运行：**

```powershell
# 设置代理环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 验证设置
Write-Host "HTTPS_PROXY: $env:HTTPS_PROXY"
Write-Host "HTTP_PROXY: $env:HTTP_PROXY"
Write-Host "GEMINI_PROXY_URL: $env:GEMINI_PROXY_URL"

# 启动应用
npm run dev
```

### 方案 3: 使用快速设置脚本

```powershell
# 运行设置脚本
.\setup-proxy-env.ps1

# 然后启动应用
npm run dev
```

## 🔍 验证配置

启动应用后，检查控制台输出：

### ✅ 成功标志：
```
✅ 代理配置已设置:
  HTTPS_PROXY: http://35.220.189.112:3128
  HTTP_PROXY: http://35.220.189.112:3128
  GEMINI_PROXY_URL: http://35.220.189.112:3128

[Gemini] Proxy agent created successfully: http://35.220.189.112:3128
[Gemini] Using proxy for Google API request
```

### ❌ 失败标志：
```
[Gemini] No proxy URL found in environment variables
[Gemini] No proxy configured - direct connection may fail
```

如果看到失败标志，说明环境变量未设置，请使用方案 1 或 2。

## 🛠️ 诊断工具

### 检查代理配置
```bash
npm run check-proxy
```

### 测试代理连接
```bash
npm run test-proxy
```

## ⚠️ 重要提示

1. **必须重启应用**: 修改环境变量后，必须停止并重新启动应用
2. **使用启动脚本**: 推荐使用 `npm run dev:proxy` 或 `.\start-with-proxy.ps1 dev`，这样每次启动都会自动设置代理
3. **环境变量作用域**: 
   - PowerShell 中设置的 `$env:变量名` 只在当前会话有效
   - 关闭窗口后需要重新设置
   - 使用启动脚本可以避免这个问题

## 📋 完整步骤示例

```powershell
# 1. 停止当前应用（如果正在运行）
# 按 Ctrl+C

# 2. 使用代理启动脚本启动
.\start-with-proxy.ps1 dev

# 或者
npm run dev:proxy

# 3. 查看控制台输出，确认看到：
# ✅ 代理配置已设置
# [Gemini] Proxy agent created successfully

# 4. 测试 API 调用
# 在浏览器中访问应用并尝试调用 Gemini API
```

## 🆘 如果仍然失败

1. **检查代理服务器状态**: 代理服务器 `35.220.189.112:3128` 可能暂时不可用
2. **检查网络连接**: 确保服务器可以访问互联网
3. **查看详细日志**: 检查控制台中的详细错误信息
4. **联系代理服务提供商**: 确认代理服务器正常运行

## 📚 相关文档

- [PROXY_SETUP_GUIDE.md](./PROXY_SETUP_GUIDE.md) - 完整代理配置指南
- [QUICK_START_PROXY.md](./QUICK_START_PROXY.md) - 快速启动参考
- [GEMINI_API_SETUP.md](./GEMINI_API_SETUP.md) - Gemini API 配置指南


