# 🔧 代理问题解决方案

## 📊 当前诊断结果

根据诊断工具的输出：

✅ **TCP 连接成功** - 可以连接到代理服务器 `35.220.189.112:3128`  
⚠️ **HTTP 代理连接失败** - 可能是代理配置或认证问题  
✅ **Gemini API 端点可达** - 可以连接到 Google 服务器

## 🎯 解决方案

### 方案 1: 使用启动脚本（推荐）

**这是最简单可靠的方法：**

```powershell
# 停止当前应用（如果正在运行）
# 按 Ctrl+C

# 使用代理启动脚本启动
.\start-with-proxy.ps1 dev
```

启动脚本会自动设置所有必需的环境变量。

### 方案 2: 在当前会话中设置环境变量

```powershell
# 设置环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 验证设置
npm run check-proxy

# 启动应用
npm run dev
```

### 方案 3: 测试完整的 Gemini API 调用

```powershell
# 先设置环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 确保设置了 API Key
# $env:GOOGLE_GEMINI_API_KEY="your-api-key"

# 测试 Gemini API
npm run test-gemini
```

## 🔍 诊断工具

### 1. 检查代理配置
```bash
npm run check-proxy
```

### 2. 测试代理连接
```bash
npm run test-proxy
```

### 3. 详细诊断
```bash
npm run diagnose-proxy
```

### 4. 测试 Gemini API（需要 API Key）
```bash
npm run test-gemini
```

## ⚠️ 常见问题

### 问题 1: TCP 连接成功但 HTTP 代理失败

**可能原因：**
- 代理服务器需要认证（用户名/密码）
- 代理服务器配置不正确
- 代理服务器不支持 HTTPS 连接

**解决方案：**
1. 联系代理服务提供商确认是否需要认证
2. 如果代理需要认证，需要在代理 URL 中包含认证信息：
   ```
   http://username:password@35.220.189.112:3128
   ```
3. 检查代理服务器是否支持 HTTPS 连接

### 问题 2: 环境变量设置后仍然失败

**可能原因：**
- 应用未重启（环境变量只在启动时读取）
- 环境变量作用域问题（只在当前会话有效）

**解决方案：**
1. 确保使用启动脚本启动应用
2. 或者在使用 `npm run dev` 之前设置环境变量

### 问题 3: 代理连接超时

**可能原因：**
- 代理服务器响应慢
- 网络连接不稳定
- 防火墙阻止连接

**解决方案：**
1. 检查网络连接
2. 联系代理服务提供商确认服务器状态
3. 检查防火墙设置

## 📝 完整测试流程

```powershell
# 1. 设置环境变量
$env:HTTPS_PROXY="http://35.220.189.112:3128"
$env:HTTP_PROXY="http://35.220.189.112:3128"
$env:GEMINI_PROXY_URL="http://35.220.189.112:3128"

# 2. 检查配置
npm run check-proxy

# 3. 诊断代理
npm run diagnose-proxy

# 4. 测试 Gemini API（如果有 API Key）
# $env:GOOGLE_GEMINI_API_KEY="your-api-key"
npm run test-gemini

# 5. 启动应用
npm run dev
```

## 🆘 如果所有方法都失败

1. **确认代理服务器状态**
   - 联系代理服务提供商
   - 确认代理服务器正常运行
   - 确认 IP 地址和端口正确

2. **检查网络连接**
   - 确保服务器可以访问互联网
   - 检查防火墙设置
   - 测试其他网络连接

3. **尝试其他代理**
   - 如果有其他代理服务器，可以尝试更换
   - 更新启动脚本中的代理地址

4. **查看详细日志**
   - 检查应用控制台输出
   - 查看浏览器开发者工具的网络请求
   - 检查服务器日志

## 📚 相关文档

- [立即修复代理问题.md](./立即修复代理问题.md) - 快速修复指南
- [PROXY_SETUP_GUIDE.md](./PROXY_SETUP_GUIDE.md) - 完整代理配置指南
- [GEMINI_API_SETUP.md](./GEMINI_API_SETUP.md) - Gemini API 配置指南


